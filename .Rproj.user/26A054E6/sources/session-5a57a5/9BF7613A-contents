---
title: "HW8"
author: "Caleb Skinner"
date: "March 14, 2024"
format:
  pdf:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#", fig.height = 3, 
  cache = FALSE,  collapse = TRUE,
  error = TRUE, echo = TRUE,
  message = FALSE, warning = FALSE)
```

```{r libraries, include = FALSE}
library("fpp3")
library("tswge")
library("janitor")
library("patchwork")
library("flextable")
```

```{r flextable, include = FALSE}
set_flextable_defaults(
  font.size = 10, theme_fun = theme_zebra,
  padding = 6,
  background.color = "#EFEFEF")
```

{{< pagebreak >}}

# Problem 1

*We fitted a harmonic regression model to part of the us_gasoline series in Exercise 5 in Section 7.10. We will now revisit this model, and extend it to include more data and ARMA errors.*

Below is my code from the previous problem from Homework 6, but without excluding the last portion of the data.

```{r}
gas_lambda <- gas %>% features(barrels, guerrero) %>% pull()
gas <- usa %>% mutate()

gas <- us_gasoline %>%
  clean_names() %>%
  mutate(
    date = date(week),
    box_cox = box_cox(barrels, gas_lambda),
    diff = difference(barrels, 52)
    ) #%>% filter(year(date) < 2005)

gas_fit <- gas %>%
  model(fourier = TSLM(barrels ~ trend() + fourier(K = 7)))

gas %>% autoplot(.vars = box_cox)
gas %>% autoplot(.vars = barrels)
gas %>% autoplot(.vars = diff)
```

## Part A

*Using TSLM(), fit a harmonic regression with a piecewise linear time trend to the full series. Select the position of the knots in the trend and the appropriate number of Fourier terms to include by minimizing the AICc or CV value.*

Dr. Patrick gave me the position of the knots, but the model was not white noise with those knot positions. Instead, I changed the knots to week 1 of 2004 and week1 of 2013. I check for the correct number of fourier terms by comparing the AICc of the models below.

The AICc, AIC, and BIC are minimized with k = 6 knots on the fourier term.

```{r}
gas_check_fourier <- gas %>%
  model(
    k1 = TSLM(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 1)),
    k5 = TSLM(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 5)),
    k6 = TSLM(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 6)),
    k7 = TSLM(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 7)),
    k20 = TSLM(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 20)))

glance(gas_check_fourier) %>% select(.model, CV, AIC, AICc, BIC) %>%
  flextable() %>%
  align(align = "center", part = "all")
```

## Part B

*Now refit the model using ARIMA() to allow for correlated errors, keeping the same predictor variables as you used with TSLM().*

I compare the results of the TSLM with an ARIMA model of the same characteristics. The ARIMA model is (2,0,2)(2,0,0). In other words, after the trend and fourier terms are applied, there is no difference needed, and an AR(2) term, MA(2) term, and AR(2) seasonal term are used in the model.

```{r}
gas_fit2 <- gas %>%
  model(ARIMA(barrels ~ trend(c(yearweek("2004 W01"), yearweek("2013 W01"))) + fourier(K = 6)))

report(gas_fit2)
```

## Part C

*Check the residuals of the final model using the gg_tsresiduals() function and a Ljung-Box test. Do they look sufficiently like white noise to continue? If not, try modifying your model, or removing the first few years of data.*

The residuals appear to have more variance in the 90s than in the early 2000s. However, these residuals appear to fit with placement of the knots. The residuals appear to be normally distributed, and there is no statistically significant autocorrelation in the residuals.

```{r}
gas_fit2 %>% gg_tsresiduals()
```

The p-value of the ljung-box test is (barely) over .05, so we can conclude that the residuals look sufficiently like white noise. The residuals differ from white noise primarily in the slight change in variance of the residuals over time.

```{r}
augment(gas_fit2) %>% 
  features(.innov, ljung_box, lag = 104) %>%
  select(lb_stat, lb_pvalue) %>%
  flextable() %>%
  align(align = "center", part = "all")
```

## Part D

*Once you have a model with white noise residuals, produce forecasts for the next year.*

The forecast looks to fit with the model appropriately. It continues with the seasonal variation, as well as the slight upward trend. However, the forecast seems to underestimate the variance of barrel production over time.

```{r}
gas_fit2 %>%
  forecast(h = 104) %>%
  autoplot(gas)
```



